<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mail App</title>
    <link rel="stylesheet" href="mail.css">
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
    <style>
        .mail-item.evaporating .evap-char {
            display: inline-block;
            will-change: transform, opacity, filter;
        }
    </style>
</head>

<body>

    <!-- ========== BACK BUTTON ========== -->
    <a href="../index.html#wrap-remove" class="back-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
    </a>

    <!-- ========== LEFT: Particle Demo ========== -->
    <div class="particle-demo">
        <div class="particle-container">
            <canvas id="particleCanvas"></canvas>
        </div>
    </div>

    <!-- ========== RIGHT: Mobile App ========== -->
    <div style="display:flex; flex-direction:column; align-items:center;">
        <div class="mobile-container">
            <!-- Status Bar -->
            <div class="status-bar">
                <span class="time">9:41</span>
                <div class="status-icons">
                    <svg width="17" height="14" viewBox="0 0 17 14" fill="none">
                        <rect x="0" y="10" width="3" height="4" rx="1" fill="#000" />
                        <rect x="4.5" y="7" width="3" height="7" rx="1" fill="#000" />
                        <rect x="9" y="4" width="3" height="10" rx="1" fill="#000" />
                        <rect x="13.5" y="0" width="3" height="14" rx="1" fill="#000" />
                    </svg>
                    <svg width="16" height="12" viewBox="0 0 16 12" fill="none">
                        <path
                            d="M8 2.5C10.5 2.5 12.7 3.5 14.3 5.1L15.7 3.7C13.7 1.7 11 0.5 8 0.5C5 0.5 2.3 1.7 0.3 3.7L1.7 5.1C3.3 3.5 5.5 2.5 8 2.5Z"
                            fill="#000" />
                        <path
                            d="M8 5.5C9.7 5.5 11.2 6.1 12.4 7.1L13.8 5.7C12.2 4.3 10.2 3.5 8 3.5C5.8 3.5 3.8 4.3 2.2 5.7L3.6 7.1C4.8 6.1 6.3 5.5 8 5.5Z"
                            fill="#000" />
                        <path
                            d="M8 8.5C9 8.5 9.9 8.9 10.5 9.5L12 8C10.9 7 9.5 6.5 8 6.5C6.5 6.5 5.1 7 4 8L5.5 9.5C6.1 8.9 7 8.5 8 8.5Z"
                            fill="#000" />
                        <circle cx="8" cy="11" r="1.5" fill="#000" />
                    </svg>
                    <div class="battery">
                        <div class="battery-body">
                            <div class="battery-level"></div>
                        </div>
                        <div class="battery-cap"></div>
                    </div>
                </div>
            </div>

            <!-- Header -->
            <header class="header">
                <h1 class="page-title">Mail</h1>
            </header>

            <!-- Mail List -->
            <div class="mail-list" id="mailList">
                <!-- Mail Item 1 - Urgent -->
                <div class="mail-item" data-id="1">
                    <div class="mail-content">
                        <div class="mail-header">
                            <span class="urgent-badge">Urgent</span>
                            <div class="sender-info">
                                <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop"
                                    alt="Jamie Park" class="avatar">
                                <span class="sender-name">Jamie Park</span>
                            </div>
                            <div class="date-arrow">
                                <span class="date">28 Jan 2026</span>
                                <svg width="8" height="14" viewBox="0 0 8 14" fill="none">
                                    <path d="M1 1L7 7L1 13" stroke="#C7C7CC" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="mail-subject">Request for Confirmation</h3>
                        <p class="mail-preview">HI, I hope you're doing well. I'm reaching out regarding If you need
                            anything from my side, I'm...</p>
                    </div>
                </div>

                <!-- Mail Item 2 -->
                <div class="mail-item" data-id="2">
                    <div class="mail-content">
                        <div class="mail-header">
                            <div class="sender-info">
                                <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100&h=100&fit=crop"
                                    alt="Emma" class="avatar">
                                <span class="sender-name">Emma</span>
                            </div>
                            <div class="date-arrow">
                                <span class="date">25 Jan 2026</span>
                                <svg width="8" height="14" viewBox="0 0 8 14" fill="none">
                                    <path d="M1 1L7 7L1 13" stroke="#C7C7CC" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="mail-subject">Final Check Needed</h3>
                        <p class="mail-preview">Just following up on my previous email about design. When you have a
                            moment,
                            could you please....</p>
                    </div>
                </div>

                <!-- Mail Item 3 -->
                <div class="mail-item" data-id="3">
                    <div class="mail-content">
                        <div class="mail-header">
                            <div class="sender-info">
                                <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop"
                                    alt="Jamie Park" class="avatar">
                                <span class="sender-name">Jamie Park</span>
                            </div>
                            <div class="date-arrow">
                                <span class="date">24 Jan 2026</span>
                                <svg width="8" height="14" viewBox="0 0 8 14" fill="none">
                                    <path d="M1 1L7 7L1 13" stroke="#C7C7CC" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="mail-subject">Meeting Confirmation</h3>
                        <p class="mail-preview">'d like to schedule a quick meeting to discuss design. Are you available
                            on
                            [option A] or [option B]? If not....</p>
                    </div>
                </div>

                <!-- Mail Item 4 -->
                <div class="mail-item" data-id="4">
                    <div class="mail-content">
                        <div class="mail-header">
                            <div class="sender-info">
                                <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop"
                                    alt="Jamie Park" class="avatar">
                                <span class="sender-name">Jamie Park</span>
                            </div>
                            <div class="date-arrow">
                                <span class="date">24 Jan 2026</span>
                                <svg width="8" height="14" viewBox="0 0 8 14" fill="none">
                                    <path d="M1 1L7 7L1 13" stroke="#C7C7CC" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="mail-subject">Feedback Request</h3>
                        <p class="mail-preview">HI, I hope you're doing well. I'm reaching out regarding If you need
                            anything from my side, I'm...</p>
                    </div>
                </div>

                <!-- Mail Item 5 -->
                <div class="mail-item" data-id="5">
                    <div class="mail-content">
                        <div class="mail-header">
                            <div class="sender-info">
                                <img src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100&h=100&fit=crop"
                                    alt="Sarah Kim" class="avatar">
                                <span class="sender-name">Sarah Kim</span>
                            </div>
                            <div class="date-arrow">
                                <span class="date">23 Jan 2026</span>
                                <svg width="8" height="14" viewBox="0 0 8 14" fill="none">
                                    <path d="M1 1L7 7L1 13" stroke="#C7C7CC" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="mail-subject">Project Update</h3>
                        <p class="mail-preview">Here's the latest update on the project. We've made significant progress
                            on
                            the UI components...</p>
                    </div>
                </div>

                <!-- Mail Item 6 -->
                <div class="mail-item" data-id="6">
                    <div class="mail-content">
                        <div class="mail-header">
                            <div class="sender-info">
                                <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&h=100&fit=crop"
                                    alt="Michael Chen" class="avatar">
                                <span class="sender-name">Michael Chen</span>
                            </div>
                            <div class="date-arrow">
                                <span class="date">22 Jan 2026</span>
                                <svg width="8" height="14" viewBox="0 0 8 14" fill="none">
                                    <path d="M1 1L7 7L1 13" stroke="#C7C7CC" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="mail-subject">Invoice Attached</h3>
                        <p class="mail-preview">Please find the invoice for last month attached. Let me know if you have
                            any
                            questions...</p>
                    </div>
                </div>

                <!-- Mail Item 7 -->
                <div class="mail-item" data-id="7">
                    <div class="mail-content">
                        <div class="mail-header">
                            <div class="sender-info">
                                <img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=100&h=100&fit=crop"
                                    alt="Lisa Wang" class="avatar">
                                <span class="sender-name">Lisa Wang</span>
                            </div>
                            <div class="date-arrow">
                                <span class="date">21 Jan 2026</span>
                                <svg width="8" height="14" viewBox="0 0 8 14" fill="none">
                                    <path d="M1 1L7 7L1 13" stroke="#C7C7CC" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="mail-subject">Team Dinner Plans</h3>
                        <p class="mail-preview">Hey everyone! I'm organizing a team dinner for next Friday. Please let
                            me
                            know your availability...</p>
                    </div>
                </div>

                <!-- Mail Item 8 -->
                <div class="mail-item" data-id="8">
                    <div class="mail-content">
                        <div class="mail-header">
                            <div class="sender-info">
                                <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=100&h=100&fit=crop"
                                    alt="David Lee" class="avatar">
                                <span class="sender-name">David Lee</span>
                            </div>
                            <div class="date-arrow">
                                <span class="date">20 Jan 2026</span>
                                <svg width="8" height="14" viewBox="0 0 8 14" fill="none">
                                    <path d="M1 1L7 7L1 13" stroke="#C7C7CC" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                        <h3 class="mail-subject">Weekly Report</h3>
                        <p class="mail-preview">Attached is the weekly performance report. Overall metrics are looking
                            good
                            this week...</p>
                    </div>
                </div>
            </div>

            <!-- Bottom Navigation -->
            <div class="bottom-nav">
                <button class="nav-btn">
                    <svg width="24" height="18" viewBox="0 0 24 18" fill="none">
                        <path d="M3 1H21" stroke="#1C1C1E" stroke-width="2" stroke-linecap="round" />
                        <path d="M3 9H21" stroke="#1C1C1E" stroke-width="2" stroke-linecap="round" />
                        <path d="M3 17H21" stroke="#1C1C1E" stroke-width="2" stroke-linecap="round" />
                    </svg>
                </button>
                <div class="update-info">
                    <span class="update-text">Updated Just Now</span>
                    <span class="unread-count">123 Unread</span>
                </div>
                <button class="nav-btn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path
                            d="M17.5 12.5L17.5 5C17.5 3.61929 16.3807 2.5 15 2.5H5C3.61929 2.5 2.5 3.61929 2.5 5L2.5 15C2.5 16.3807 3.61929 17.5 5 17.5H12.5"
                            stroke="#1C1C1E" stroke-width="1.5" stroke-linecap="round" />
                        <path d="M15 14V19M15 19L17.5 16.5M15 19L12.5 16.5" stroke="#1C1C1E" stroke-width="1.5"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </button>
            </div>

            <!-- Home Indicator -->
            <div class="home-indicator"></div>
        </div>
        <p style="color:#888; font-size:16px; font-weight:500; letter-spacing:-0.3px; margin-top:-40px;">메일 항목을 지워보세요
        </p>
    </div>
    <script>
        // ==========================================
        // LEFT: Particle Animation (3D Sphere)
        // ==========================================
        const pCanvas = document.getElementById('particleCanvas');
        const pCtx = pCanvas.getContext('2d');
        const pContainer = document.querySelector('.particle-container');

        let pWidth, pHeight;
        let particles = [];
        let particleProgress = 0; // 0 = sphere, 1 = fully scattered

        const PARTICLE_COUNT = 25000;
        const CIRCLE_RADIUS = 120;

        const PALETTE = [
            { r: 60, g: 60, b: 60 },
            { r: 20, g: 20, b: 20 },
            { r: 80, g: 80, b: 80 }
        ];

        function lerpColor(c1, c2, factor) {
            return {
                r: Math.floor(c1.r + (c2.r - c1.r) * factor),
                g: Math.floor(c1.g + (c2.g - c1.g) * factor),
                b: Math.floor(c1.b + (c2.b - c1.b) * factor)
            };
        }

        function resizeParticle() {
            const rect = pContainer.getBoundingClientRect();
            pWidth = rect.width;
            pHeight = rect.height;
            pCanvas.width = pWidth;
            pCanvas.height = pHeight;
            initParticles();
        }

        class Particle {
            constructor(x, y, colorStr, centerX, centerY) {
                this.originX = x;
                this.originY = y;
                this.simX = x;
                this.simY = y;
                this.vx = 0;
                this.vy = 0;
                this.simAlpha = 1;
                this.simSize = 1;
                this.size = Math.random() * 1.5 + 1.5;
                this.colorStr = colorStr;

                // Distance from center determines evaporation order (edge first)
                const dist = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);
                this.distRatio = dist / CIRCLE_RADIUS;

                // Each particle has unique noise seeds for wispy movement
                this.noiseSeedX = Math.random() * 100;
                this.noiseSeedY = Math.random() * 100;
                this.swayAmount = 1.5 + Math.random() * 2.5;
                this.baseAngle = Math.atan2(y - centerY, x - centerX);
            }

            update(time) {
                // Outward scatter (original feel - blown away from center)
                this.vx += Math.cos(this.baseAngle) * 0.15;
                this.vy += Math.sin(this.baseAngle) * 0.15;

                // Noise-driven turbulence (original organic movement)
                const noiseAngle = Math.sin(this.simX * 0.01 + time) * Math.cos(this.simY * 0.01 - time) * Math.PI * 2;
                this.vx += Math.cos(noiseAngle) * 0.25;
                this.vy += Math.sin(noiseAngle) * 0.25;

                // Slight upward bias (wind carrying particles up)
                this.vy -= 0.05;

                // Wispy sway
                const sway = Math.sin(time * 0.8 + this.noiseSeedX) * this.swayAmount;
                this.vx += sway * 0.006;

                this.vx *= 0.94;
                this.vy *= 0.94;
                this.simX += this.vx;
                this.simY += this.vy;

                // Gradual fade & shrink
                if (this.simAlpha > 0) this.simAlpha -= 0.008;
                if (this.simSize > 0) this.simSize -= 0.004;
            }

            draw(progress) {
                const x = this.originX + (this.simX - this.originX) * progress;
                const y = this.originY + (this.simY - this.originY) * progress;
                const alpha = 1 - (1 - Math.max(0, this.simAlpha)) * progress;
                const sizeMult = 1 - (1 - Math.max(0, this.simSize)) * progress;

                if (alpha < 0.01 || sizeMult < 0.01) return;
                const drawSize = this.size * sizeMult;
                pCtx.fillStyle = this.colorStr.replace(')', `, ${alpha})`);
                pCtx.beginPath();
                pCtx.arc(x, y, drawSize * 0.5, 0, Math.PI * 2);
                pCtx.fill();
            }
        }

        function initParticles() {
            particles = [];
            const centerX = pWidth / 2;
            const centerY = pHeight / 2;

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = Math.sqrt(Math.random()) * CIRCLE_RADIUS;
                const x = centerX + Math.cos(angle) * r;
                const y = centerY + Math.sin(angle) * r;

                const nx = (x - centerX) / CIRCLE_RADIUS;
                const ny = (y - centerY) / CIRCLE_RADIUS;
                let t = (nx + ny + 1.414) / 2.828;
                t = Math.max(0, Math.min(1, t));

                let finalColor;
                if (t < 0.5) {
                    finalColor = lerpColor(PALETTE[0], PALETTE[1], t * 2);
                } else {
                    finalColor = lerpColor(PALETTE[1], PALETTE[2], (t - 0.5) * 2);
                }

                const colorStr = `rgb(${finalColor.r},${finalColor.g},${finalColor.b})`;
                particles.push(new Particle(x, y, colorStr, centerX, centerY));
            }
        }

        function animateParticles() {
            pCtx.clearRect(0, 0, pWidth, pHeight);
            const time = Date.now() * 0.002;
            for (let i = 0; i < particles.length; i++) {
                particles[i].update(time);
                particles[i].draw(particleProgress);
            }
            requestAnimationFrame(animateParticles);
        }

        resizeParticle();
        animateParticles();

        function setParticleProgress(p) {
            const prev = particleProgress;
            particleProgress = Math.max(0, Math.min(1, p));
            // Reset physics when back to sphere so next scatter starts fresh
            if (particleProgress === 0 && prev > 0) {
                for (let i = 0; i < particles.length; i++) {
                    const pt = particles[i];
                    pt.simX = pt.originX;
                    pt.simY = pt.originY;
                    pt.vx = 0;
                    pt.vy = 0;
                    pt.simAlpha = 1;
                    pt.simSize = 1;
                }
            }
        }

        // ==========================================
        // RIGHT: Mail Evaporation Logic
        // ==========================================
        function prepareEvaporation(element) {
            const text = element.innerText;
            element.innerHTML = text.split('').map((char, index) => {
                if (char === ' ') return '<span class="evap-char" style="width: 0.3em;">&nbsp;</span>';
                const randomY = -30 - Math.random() * 50;
                const randomX = 20 + Math.random() * 60;
                const randomR = (Math.random() - 0.5) * 25;
                const delay = index * 0.02;
                return `<span class="evap-char" 
                            data-y="${randomY}" 
                            data-x="${randomX}" 
                            data-r="${randomR}"
                            data-delay="${delay}"
                        >${char}</span>`;
            }).join('');
        }

        const mailList = document.getElementById('mailList');
        let startX = 0;
        let currentX = 0;
        let currentItem = null;
        let isDragging = false;
        let isEvaporating = false;
        let evaporationProgress = 0;
        let boxOffset = 0;
        let allChars = [];
        let mailAvatar = null;
        let senderInfo = null;
        let arrow = null;

        const SWIPE_THRESHOLD = 40;
        const MAX_SWIPE = 250;

        function handleTouchStart(e) {
            const mailItem = e.target.closest('.mail-item');
            if (!mailItem || mailItem.classList.contains('deleting')) return;

            currentItem = mailItem;
            startX = e.touches ? e.touches[0].clientX : e.clientX;
            currentX = startX;
            isDragging = true;
            isEvaporating = false;
            evaporationProgress = 0;
            boxOffset = 0;

            currentItem.classList.add('evaporating');
            const subject = currentItem.querySelector('.mail-subject');
            const preview = currentItem.querySelector('.mail-preview');
            const senderName = currentItem.querySelector('.sender-name');
            const date = currentItem.querySelector('.date');
            const badge = currentItem.querySelector('.urgent-badge');

            if (subject) prepareEvaporation(subject);
            if (preview) prepareEvaporation(preview);
            if (senderName) prepareEvaporation(senderName);
            if (date) prepareEvaporation(date);
            if (badge) prepareEvaporation(badge);

            allChars = currentItem.querySelectorAll('.evap-char');
            mailAvatar = currentItem.querySelector('.avatar');
            senderInfo = currentItem.querySelector('.sender-info');
            arrow = currentItem.querySelector('.date-arrow svg');
        }

        function handleTouchMove(e) {
            if (!isDragging || !currentItem) return;
            currentX = e.touches ? e.touches[0].clientX : e.clientX;
            let deltaX = currentX - startX;
            if (deltaX < 0) deltaX = 0;
            if (deltaX > MAX_SWIPE) deltaX = MAX_SWIPE;
            boxOffset = deltaX;
            evaporationProgress = deltaX / MAX_SWIPE;
            isEvaporating = deltaX > 0;
            updateVisuals();
        }

        function updateVisuals() {
            if (!currentItem) return;
            currentItem.style.transform = `translateX(${boxOffset}px)`;

            const eased = evaporationProgress < 0.5
                ? 2 * evaporationProgress * evaporationProgress
                : 1 - Math.pow(-2 * evaporationProgress + 2, 2) / 2;

            allChars.forEach(char => {
                const yTarget = parseFloat(char.dataset.y) || -40;
                const xTarget = parseFloat(char.dataset.x) || 30;
                const rTarget = parseFloat(char.dataset.r) || 0;
                const delay = parseFloat(char.dataset.delay) || 0;
                const delayedProgress = Math.max(0, eased - delay);
                const localP = Math.min(1, delayedProgress * 1.5);
                const y = localP * yTarget;
                const x = localP * xTarget;
                const r = localP * rTarget;
                const s = 1 - (localP * 0.4);
                char.style.transform = `translate(${x}px, ${y}px) rotate(${r}deg) scale(${s})`;
                char.style.opacity = 1 - (localP * 0.9);
                char.style.filter = `blur(${localP * 2.5}px)`;
            });

            if (mailAvatar) {
                mailAvatar.style.opacity = 1 - eased;
                mailAvatar.style.transform = `scale(${1 - eased * 0.3}) translateX(${eased * 20}px)`;
                mailAvatar.style.filter = `blur(${eased * 2}px)`;
            }
            if (senderInfo) {
                senderInfo.style.background = `rgba(249, 250, 250, ${1 - eased})`;
            }
            if (arrow) {
                arrow.style.opacity = 1 - eased;
            }
            currentItem.style.background = `rgba(255, 255, 255, ${1 - eased})`;
            currentItem.style.boxShadow = `0 2px 8px rgba(0, 0, 0, ${0.08 * (1 - eased)})`;

            // Sync particle with mail evaporation progress
            setParticleProgress(evaporationProgress);
        }

        function handleTouchEnd() {
            if (!isDragging || !currentItem) return;
            const deltaX = currentX - startX;
            const itemToHandle = currentItem;

            if (deltaX > SWIPE_THRESHOLD * 1.5) {
                itemToHandle.classList.add('deleting');
                const startProgress = evaporationProgress;
                const startOffset = boxOffset;
                const startTime = performance.now();
                const DURATION = 100;

                function animateComplete(currentTime) {
                    const elapsed = currentTime - startTime;
                    const t = Math.min(1, elapsed / DURATION);
                    const eased = 1 - Math.pow(1 - t, 3);
                    evaporationProgress = startProgress + (1 - startProgress) * eased;
                    boxOffset = startOffset + (MAX_SWIPE + 50 - startOffset) * eased;
                    updateVisuals();

                    if (t < 1) {
                        requestAnimationFrame(animateComplete);
                    } else {
                        const currentHeight = itemToHandle.offsetHeight;
                        itemToHandle.style.transition = 'height 0.15s ease-out, margin 0.15s ease-out';
                        itemToHandle.style.height = currentHeight + 'px';
                        itemToHandle.style.overflow = 'hidden';
                        requestAnimationFrame(() => {
                            itemToHandle.style.height = '0';
                            itemToHandle.style.marginBottom = '0';
                            setTimeout(() => {
                                itemToHandle.remove();
                                // Wait 1s, then fade in restored sphere
                                setTimeout(() => {
                                    // Hide canvas, reset particles, then fade in
                                    pCanvas.style.transition = 'none';
                                    pCanvas.style.opacity = '0';
                                    setParticleProgress(0);
                                    // Force browser to paint opacity:0 first
                                    requestAnimationFrame(() => {
                                        requestAnimationFrame(() => {
                                            pCanvas.style.transition = 'opacity 0.5s ease-in';
                                            pCanvas.style.opacity = '1';
                                        });
                                    });
                                    setTimeout(() => {
                                        pCanvas.style.transition = '';
                                    }, 100);
                                }, 800);
                            }, 150);
                        });
                    }
                }
                requestAnimationFrame(animateComplete);
            } else {
                const startProgress = evaporationProgress;
                const startOffset = boxOffset;
                const startTime = performance.now();
                const DURATION = 300;

                function animateBack(currentTime) {
                    const elapsed = currentTime - startTime;
                    const t = Math.min(1, elapsed / DURATION);
                    const eased = 1 - Math.pow(1 - t, 2);
                    evaporationProgress = startProgress * (1 - eased);
                    boxOffset = startOffset * (1 - eased);
                    updateVisuals();

                    if (t < 1) {
                        requestAnimationFrame(animateBack);
                    } else {
                        itemToHandle.classList.remove('evaporating');
                        itemToHandle.style.transform = '';
                        itemToHandle.style.background = '';
                        allChars.forEach(char => {
                            char.style.transform = '';
                            char.style.opacity = '';
                            char.style.filter = '';
                        });
                        if (mailAvatar) {
                            mailAvatar.style.opacity = '';
                            mailAvatar.style.transform = '';
                            mailAvatar.style.filter = '';
                        }
                        if (senderInfo) senderInfo.style.background = '';
                        if (arrow) arrow.style.opacity = '';
                    }
                }
                requestAnimationFrame(animateBack);
            }

            isDragging = false;
            currentItem = null;
            startX = 0;
            currentX = 0;
        }

        mailList.addEventListener('touchstart', handleTouchStart, { passive: true });
        mailList.addEventListener('touchmove', handleTouchMove, { passive: true });
        mailList.addEventListener('touchend', handleTouchEnd);
        mailList.addEventListener('mousedown', handleTouchStart);
        document.addEventListener('mousemove', (e) => { if (isDragging) handleTouchMove(e); });
        document.addEventListener('mouseup', handleTouchEnd);
    </script>
</body>

</html>